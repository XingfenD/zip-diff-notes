# Stage1-Week3

## Target

通读方法与实验部分，整理技术路线（差异检测→样本生成→多解析器对比）

### Detailed

- 学习理解ZIPDIFF的工作流程；

### Deliverables

详细的技术路线图 + 文字解释 + 讲解

## Content

### 工作流程概览

```mermaid
sequenceDiagram
    participant 初始化模块
    participant 测试用例生成器
    participant UCB策略选择器
    participant 变异引擎
    participant 多解析器测试执行器
    participant 差异分析器
    participant 结果存储
    participant 50个ZIP解析器

    %% 初始化阶段
    初始化模块->>初始化模块: 收集19种语言的50个ZIP解析器
    初始化模块->>初始化模块: 创建Docker隔离环境
    初始化模块->>UCB策略选择器: 初始化46种变异策略权重
    初始化模块->>结果存储: 初始化语料库和统计信息

    %% 初始测试用例生成
    初始化模块->>测试用例生成器: 请求生成初始测试用例
    测试用例生成器->>测试用例生成器: 生成1000个基础ZIP文件
    测试用例生成器->>结果存储: 存储初始测试用例集

    loop 迭代优化 (最多10000次)
        %% 选择种子样本
        结果存储->>结果存储: 选择种子样本

        %% UCB策略选择
        结果存储->>UCB策略选择器: 获取当前样本
        UCB策略选择器->>UCB策略选择器: 计算各策略UCB权重
        UCB策略选择器->>UCB策略选择器: 应用softmax选择策略
        UCB策略选择器->>变异引擎: 返回选择的变异策略

        %% 应用变异
        结果存储->>变异引擎: 提供种子样本
        变异引擎->>变异引擎: 应用ZIP级别变异
        变异引擎->>变异引擎: 应用字节级别变异
        变异引擎->>多解析器测试执行器: 输出变异后的测试用例

        %% 多解析器并行测试
        多解析器测试执行器->>50个ZIP解析器: 并行执行测试
        50个ZIP解析器->>多解析器测试执行器: 返回解析结果
        多解析器测试执行器->>差异分析器: 传递所有解析结果

        %% 差异分析
        差异分析器->>差异分析器: 计算输出目录哈希
        差异分析器->>差异分析器: 比较解析结果
        差异分析器->>差异分析器: 识别不一致解析器对
        差异分析器->>结果存储: 存储分析结果

        %% 更新UCB参数
        差异分析器->>UCB策略选择器: 反馈变异效果
        UCB策略选择器->>UCB策略选择器: 更新策略权重
        UCB策略选择器->>UCB策略选择器: 应用权重衰减机制

        %% 更新语料库
        alt 发现新的不一致性
            差异分析器->>结果存储: 添加到语料库
            结果存储->>结果存储: 更新统计信息
        end

        %% 定期报告
        alt 每1000次迭代
            结果存储->>结果存储: 生成状态报告
        end
    end

    %% 最终结果
    结果存储->>结果存储: 生成最终报告
    结果存储->>结果存储: 整理14种解析歧义类型
    结果存储->>结果存储: 统计1221/1225不一致解析器对
```

### 工作流程详细解释

#### 测试用例生成器

```mermaid
graph TD
    subgraph 初始化阶段
        A["开始初始化"] --> A1["构建基础样本"]
        A1 --> A1a["创建包含标准结构的ZIP<br/>- 文件: 'a' (内容'a')<br/>- 目录文件: 'b/c' (内容'c')、'b/d' (内容'd')<br/>- 完成ZIP归档(finalize)"]

        A --> A2["生成随机样本集<br/>(数量=配置的batch_size)"]
        A2 --> A2a["随机化文件数量<br/>(0-5个文件)"]
        A2 --> A2b["随机生成文件名<br/>(长度0-5字节，随机字符串)"]
        A2 --> A2c["随机生成文件内容<br/>(长度0-10字节，随机字节)"]
        A2 --> A2d["随机选择压缩算法<br/>- 80%概率: STORED/DEFLATED<br/>- 20%概率: BZIP2/ZSTD/LZMA/XZ"]
        A2 --> A2e["随机添加EOCD记录<br/>(20%概率添加ZIP结束标记)"]
        A2a & A2b & A2c & A2d & A2e --> A2f["组装并完成ZIP归档"]

        A1a & A2f --> A3["初始语料库生成完成"]
    end

    subgraph 变异生成阶段
        B["从语料库选择种子样本"] --> C["随机决定变异次数<br/>(1-32次，概率2^-x)"]
        C --> D{"应用变异操作"}

        D -->|"结构级变异"| E["ZIP结构修改"]
        E --> E1["文件条目操作<br/>- AddFileEntry(添加文件)<br/>- RemoveLfh/RemoveCdh(删除头信息)"]
        E --> E2["字段修改<br/>- ModifyCrc32(校验值)<br/>- ModifyCompressionMethod(压缩方式)"]

        D -->|"字节级变异"| F["原始字节修改"]
        F --> F1["基础修改<br/>- ModifyByte(修改字节)<br/>- FlipBit(翻转比特)"]
        F --> F2["片段操作<br/>- InsertBytes(插入)<br/>- DeleteBytes(删除)"]

        E & F --> G["生成新测试用例"]
    end

    subgraph 管理与输出
        G --> H["去重检查<br/>(通过blake3哈希校验)"]
        H --> I{"已存在?"}
        I -->|"是"| J["丢弃重复样本"]
        I -->|"否"| K["添加到语料库"]
        K --> L["结合手动构造用例<br/>(如路径歧义测试: '/a/b'与'a\\b')"]
        L --> M["输出完整测试用例集"]
    end

    A3 --> B
    K --> B
```

## Questions
